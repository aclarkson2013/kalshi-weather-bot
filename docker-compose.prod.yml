# Production overrides — use with:
#   docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d
#
# Required env vars:
#   POSTGRES_PASSWORD  — strong random password for PostgreSQL
#   GF_ADMIN_PASSWORD  — Grafana admin password (not "admin")
#   ENCRYPTION_KEY     — Fernet key for API key encryption

services:
  backend:
    command: >
      uvicorn backend.main:app
      --host 0.0.0.0
      --port 8000
      --workers 4
      --log-level warning
    volumes: []  # Remove dev hot-reload volume mount
    environment:
      - ENVIRONMENT=production
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 512M

  celery-worker:
    command: >
      celery -A backend.celery_app worker
      --loglevel=warning
      --concurrency=4
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.25"
          memory: 256M

  celery-beat:
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M

  frontend:
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M

  postgres:
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?Set POSTGRES_PASSWORD in .env or environment}
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 2G
        reservations:
          cpus: "0.5"
          memory: 512M

  redis:
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 512M

  grafana:
    environment:
      GF_SECURITY_ADMIN_PASSWORD: ${GF_ADMIN_PASSWORD:?Set GF_ADMIN_PASSWORD in .env or environment}
